<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GINZA SATAKE 納品書</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <!-- Firebase SDKの追加 -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
      :root {
      --ink: #1a1a1a;
      --gold: #8c6d46;
      --light-gold: #f5f2eb;
      --muted: #666;
      --line: #d9d2c5;
      --font-sans: 'Noto Sans JP', 'Hiragino Sans', 'Meiryo', sans-serif;
      }

      * {
      box-sizing: border-box;
      }

      body {
      font-family: var(--font-sans);
      color: var(--ink);
      background: #fff;
      margin: 0;
      line-height: 1.6;
      font-weight: 400;
      }

      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
      }

      .nav {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--line);
      }

      .nav-btn {
        background: none;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        cursor: pointer;
        color: var(--muted);
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
      }

      .nav-btn.active {
        color: var(--gold);
        border-bottom-color: var(--gold);
        font-weight: 500;
      }

      .page {
        display: none;
      }

      .page.active {
        display: block;
      }

      .sheet {
      width: 210mm;
      height: 297mm;
      margin: 0 auto;
      padding: 10mm 18mm;
      box-sizing: border-box;
      position: relative;
      overflow: hidden;
      }

      header {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--gold);
      padding-bottom: 6mm;
      margin-bottom: 8mm;
      font-size: 12px;
      align-items: flex-end;
      }

      header .company-info {
      line-height: 1.6;
      }

      header .document-info {
      text-align: right;
      line-height: 1.6;
      }

      .logo {
      text-align: center;
      margin-bottom: 6mm;
      }

      .logo img {
      height: 28px;
      }

      h1 {
      text-align: center;
      font-size: 20px;
      letter-spacing: 0.2em;
      margin: 8mm 0 10mm;
      font-weight: 500;
      }

      .customer {
      border: 1px solid var(--line);
      border-radius: 2px;
      padding: 12px 16px;
      font-size: 13px;
      margin-bottom: 8mm;
      background: var(--light-gold);
      }

      .customer label {
      color: var(--muted);
      font-size: 11px;
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      }

      .customer input, .customer textarea, select {
      width: 100%;
      border: none;
      border-bottom: 1px solid transparent;
      padding: 4px 0;
      font-size: 13px;
      resize: none;
      background: transparent;
      font-family: var(--font-sans);
      }

      .customer input:focus, .customer textarea:focus, select:focus {
      outline: none;
      border-color: var(--gold);
      }

      .customer-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
      }

      /* 顧客名の表示 */
      .customer-name-container {
      position: relative;
      }

      .name-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
      }

      .sama {
      position: absolute;
      right: 0;
      bottom: 4px;
      color: var(--muted);
      font-size: 13px;
      }

      /* 郵便番号入力フィールド */
      .zip-input-container {
      position: relative;
      display: flex;
      align-items: center;
      }

      .zip-display {
      color: var(--ink);
      margin-right: 4px;
      }

      table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8mm;
      font-size: 13px;
      border: 1px solid var(--line);
      }

      th, td {
      border-bottom: 1px solid var(--line);
      padding: 8px 10px;
      vertical-align: top;
      }

      th {
      background: var(--light-gold);
      text-align: left;
      color: var(--muted);
      font-weight: 500;
      font-size: 12px;
      }

      td input, td textarea {
      width: 100%;
      border: none;
      font-size: 13px;
      padding: 4px;
      line-height: 1.5;
      color: var(--ink);
      background: transparent;
      font-family: var(--font-sans);
      resize: none;
      height: 54px; /* 3行分の高さ */
      overflow: hidden;
      }

      td.num input {
      text-align: right;
      }

      td.line-total {
      text-align: right;
      font-weight: 500;
      }

      .sum-box {
      width: 260px;
      margin-left: auto;
      font-size: 14px;
      margin-bottom: 10mm;
      border: 1px solid var(--line);
      }

      .sum-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      border-bottom: 1px solid var(--line);
      }

      .sum-row:last-child {
      border-bottom: none;
      background: var(--light-gold);
      }

      .sum-row strong {
      font-size: 15px;
      }

      /* 合計金額の強調表示 */
      .total-amount {
      font-size: 16px !important;
      font-weight: 600;
      color: var(--ink);
      }

      .notes {
      border-top: 1px solid var(--gold);
      padding-top: 6mm;
      font-size: 11px;
      line-height: 1.7;
      color: var(--muted);
      }

      footer {
      border-top: 1px solid var(--gold);
      margin-top: 10mm;
      padding-top: 4mm;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      }

      .actions {
      margin: 10px 0 14px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      }

      .btn {
      background: var(--ink);
      color: #fff;
      border: none;
      border-radius: 2px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 500;
      font-family: var(--font-sans);
      }

      .btn.secondary {
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--ink);
      }

      /* 印刷時のスタイル */
      @media print {
      .actions, .nav { display: none; }
      input, textarea, select {
      border: none !important;
      appearance: none;
      background: transparent !important;
      }
      body { -webkit-print-color-adjust: exact; }
      .sheet {
      padding: 5mm 5mm;
      height: auto;
      min-height: 297mm;
      }

      /* 納品日の印刷スタイル */
      #deliver-display {
      display: inline !important;
      }
      #deliver {
      display: none !important;
      }

      /* 顧客名の印刷スタイル - 修正 */
      .customer-name-container {
      position: relative;
      }

      .name-wrapper {
      display: flex;
      align-items: center;
      }

      /* 入力フィールドを非表示にして、代わりにテキストを表示 */
      #custName {
      display: none;
      }

      .customer-name-container::after {
      content: attr(data-print-name) " 様";
      display: block;
      padding: 4px 0;
      font-size: 13px;
      color: var(--ink);
      }
      }

      /* 画面表示時のスタイル */
      #deliver-display {
      display: none;
      }

      /* 履歴ページのスタイル */
      .history-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .search-input {
        padding: 8px 12px;
        border: 1px solid var(--line);
        border-radius: 2px;
        font-size: 14px;
        font-family: var(--font-sans);
        flex: 1;
        min-width: 200px;
      }

      .history-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      .history-table th,
      .history-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--line);
      }

      .history-table th {
        background-color: var(--light-gold);
        font-weight: 500;
        color: var(--muted);
      }

      .history-table tr:hover {
        background-color: #f9f9f9;
      }

      .checkbox-cell {
        width: 40px;
        text-align: center;
      }

      .action-cell {
        width: 120px;
      }

      .no-data {
        text-align: center;
        padding: 40px;
        color: var(--muted);
      }

      .history-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .update-no-btn {
        background: var(--gold);
        color: white;
        border: none;
        border-radius: 2px;
        padding: 8px 16px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 500;
        font-family: var(--font-sans);
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--gold);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 10px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .status-message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        text-align: center;
      }

      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="nav">
        <button class="nav-btn active" data-page="create">納品書作成</button>
        <button class="nav-btn" data-page="history">納品書履歴</button>
      </div>

      <!-- 納品書作成ページ -->
      <div id="create-page" class="page active">
        <div class="sheet">
          <div class="logo">
            <img
              src="https://cdn.shopify.com/s/files/1/0682/9470/5317/files/logo0.svg"
              alt="GINZA SATAKE"
            />
          </div>

          <header>
            <div class="company-info">
              〒104-0061 東京都中央区銀座7-3-6 銀座髙木ビル2F<br />
              TEL: 03-6263-8316<br />登録番号: T3011401018313
            </div>
            <div class="document-info">
              納品書番号: <span id="no"></span><br />
              発行日: <span id="issue"></span><br />
              納品日: <input type="date" id="deliver" />
              <span id="deliver-display"></span>
            </div>
          </header>

          <h1>納 品 書</h1>

          <div class="customer">
            <div class="customer-grid">
              <div class="customer-name-container" id="name-container">
                <label>お名前</label>
                <div class="name-wrapper">
                  <input id="custName" placeholder="山田太郎" maxlength="8" />
                </div>
              </div>
              <div>
                <label>お支払方法</label>
                <select id="pay">
                  <option>クレジットカード</option>
                  <option>銀行振込</option>
                  <option>代金引換</option>
                  <option>店頭支払</option>
                </select>
              </div>
            </div>
            <div style="margin-top: 8px;">
              <label>郵便番号</label>
              <div class="zip-input-container">
                <span class="zip-display">〒</span>
                <input id="custZip" placeholder="100-0001" maxlength="8" />
              </div>
            </div>
            <div style="margin-top: 6px;">
              <label>ご住所</label>
              <textarea
                id="custAddr"
                rows="1"
                placeholder="東京都千代田区"
              ></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn" id="add">＋ 行を追加</button>
            <button class="btn secondary" id="clear">行をクリア</button>
            <button class="btn" id="save">保存</button>
            <button class="btn" onclick="window.print()">印刷 / PDF</button>
          </div>

          <table id="tbl">
            <thead>
              <tr>
                <th style="width:15%">品番号</th>
                <th>商品内容</th>
                <th style="width:15%">単価（税込）</th>
                <th style="width:10%">数量</th>
                <th style="width:15%">小計（税込）</th>
              </tr>
            </thead>
            <tbody id="body"></tbody>
          </table>

          <div class="sum-box">
            <div class="sum-row">
              <div>税抜金額</div>
              <div id="exSub">¥0</div>
            </div>
            <div class="sum-row">
              <div>消費税（10％）</div>
              <div id="tax">¥0</div>
            </div>
            <div class="sum-row">
              <strong>合計（税込）</strong
              ><strong id="total" class="total-amount">¥0</strong>
            </div>
          </div>

          <div class="notes">
            恐れ入りますが、商品の性質上、原則として返品・交換は承っておりません。
            万が一不良品やご注文内容と異なる商品がございました場合は、早急にご対応させていただきます。
            バッグ・革製品につきましては、水濡れや湿気などにより素材が変質・変色する場合がございます。
            ご使用・保管の際には十分ご注意くださいませ。
          </div>

          <footer>
            <div>恒宸株式会社（GINZA SATAKE）</div>
            <div>© GINZA SATAKE All Rights Reserved.</div>
          </footer>
        </div>
      </div>

      <!-- 納品書履歴ページ -->
      <div id="history-page" class="page">
        <div class="history-controls">
          <input
            type="text"
            id="search-no"
            class="search-input"
            placeholder="納品書番号で検索"
          />
          <input type="date" id="search-date" class="search-input" />
          <button class="btn" id="search-btn">検索</button>
          <button class="btn secondary" id="clear-search">検索クリア</button>
          <button class="update-no-btn" id="update-no">納品書番号更新</button>
        </div>

        <div id="status-message"></div>

        <table class="history-table">
          <thead>
            <tr>
              <th class="checkbox-cell">
                <input type="checkbox" id="select-all" />
              </th>
              <th>納品書番号</th>
              <th>発行日</th>
              <th>納品日</th>
              <th>顧客名</th>
              <th>合計金額</th>
              <th class="action-cell">操作</th>
            </tr>
          </thead>
          <tbody id="history-body">
            <!-- 履歴データがここに表示されます -->
          </tbody>
        </table>

        <div id="no-history" class="no-data" style="display: none;">
          履歴データがありません
        </div>

        <div class="history-actions">
          <button class="btn" id="download-selected">
            選択した項目をダウンロード
          </button>
          <button class="btn secondary" id="delete-selected">
            選択した項目を削除
          </button>
        </div>
      </div>
    </div>

    <script>
      // Firebaseの初期化
      const firebaseConfig = {
        apiKey: "AIzaSyB0DTvh0QSAlVt05dBuLg8wA-yFejOCu1w",
        authDomain: "coffee-ginza-kb.firebaseapp.com",
        databaseURL: "https://coffee-ginza-kb-default-rtdb.firebaseio.com",
        projectId: "coffee-ginza-kb",
        storageBucket: "coffee-ginza-kb.firebasestorage.app",
        messagingSenderId: "463453581877",
        appId: "1:463453581877:web:69002929a5298f194ff77c",
        measurementId: "G-6NVRDHQBBK"
      };

      // Firebaseを初期化
      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const $ = id => document.getElementById(id);
      const fmt = n => "¥" + (Number(n) || 0).toLocaleString("ja-JP");

      let rowCounter = 1;
      const MAX_ROWS = 5;

      // ページ切り替え機能
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // すべてのページとナビゲーションボタンを非アクティブにする
          document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
          });
          document.querySelectorAll('.nav-btn').forEach(navBtn => {
            navBtn.classList.remove('active');
          });

          // クリックされたボタンと対応するページをアクティブにする
          this.classList.add('active');
          $(`${this.dataset.page}-page`).classList.add('active');

          // 履歴ページに切り替えた場合は履歴を読み込む
          if (this.dataset.page === 'history') {
            loadHistory();
          }
        });
      });

      // ステータスメッセージ表示関数
      function showStatus(message, type = 'success') {
        const statusDiv = $('status-message');
        statusDiv.textContent = message;
        statusDiv.className = `status-message status-${type}`;
        statusDiv.style.display = 'block';

        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 3000);
      }

      // 納品書データの保存と読み込み
      async function saveInvoice() {
        const saveBtn = $('save');
        const originalText = saveBtn.textContent;

        try {
          saveBtn.innerHTML = '保存中 <span class="loading"></span>';
          saveBtn.disabled = true;

          const invoiceData = {
            no: $("no").textContent,
            issue: $("issue").textContent,
            deliver: $("deliver").value,
            custName: $("custName").value,
            pay: $("pay").value,
            custZip: $("custZip").value,
            custAddr: $("custAddr").value,
            items: [],
            total: $("total").textContent,
            createdAt: new Date().toISOString()
          };

          // 商品データを収集
          [...$("body").rows].forEach(tr => {
            const item = {
              code: tr.querySelector("td:first-child input").value,
              description: tr.querySelector("td:nth-child(2) textarea").value,
              price: tr.querySelector(".price").value,
              qty: tr.querySelector(".qty").value,
              lineTotal: tr.querySelector(".line-total").textContent
            };
            invoiceData.items.push(item);
          });

          // Firebaseに保存
          await database.ref('invoices/' + invoiceData.no).set(invoiceData);
          showStatus('納品書を保存しました');

        } catch (error) {
          console.error('保存エラー:', error);
          showStatus('保存に失敗しました', 'error');
        } finally {
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }

      async function loadHistory() {
        const historyBody = $('history-body');
        const noHistory = $('no-history');

        try {
          historyBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">読み込み中...</td></tr>';

          const snapshot = await database.ref('invoices').once('value');
          const invoicesData = snapshot.val();

          if (!invoicesData) {
            historyBody.innerHTML = '';
            noHistory.style.display = 'block';
            return;
          }

          noHistory.style.display = 'none';
          historyBody.innerHTML = '';

          const invoices = Object.keys(invoicesData).map(key => ({
            ...invoicesData[key],
            id: key
          }));

          // 発行日でソート（新しい順）
          invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          invoices.forEach(invoice => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="checkbox-cell"><input type="checkbox" class="select-item" data-no="${invoice.no}"></td>
              <td>${invoice.no}</td>
              <td>${invoice.issue}</td>
              <td>${formatDateForDisplay(invoice.deliver)}</td>
              <td>${invoice.custName}</td>
              <td>${invoice.total}</td>
              <td class="action-cell">
                <button class="btn" onclick="loadInvoice('${invoice.no}')">表示</button>
                <button class="btn secondary" onclick="deleteInvoice('${invoice.no}')">削除</button>
              </td>
            `;
            historyBody.appendChild(tr);
          });

        } catch (error) {
          console.error('履歴読み込みエラー:', error);
          historyBody.innerHTML = '';
          noHistory.style.display = 'block';
          showStatus('履歴の読み込みに失敗しました', 'error');
        }
      }

      function formatDateForDisplay(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}/${month}/${day}`;
      }

      async function loadInvoice(no) {
        try {
          const snapshot = await database.ref('invoices/' + no).once('value');
          const invoice = snapshot.val();

          if (!invoice) {
            alert('指定された納品書が見つかりません');
            return;
          }

          // 納品書作成ページにデータを設定
          $("no").textContent = invoice.no;
          $("issue").textContent = invoice.issue;
          $("deliver").value = invoice.deliver;
          updateDeliverDisplay();
          $("custName").value = invoice.custName;
          updatePrintName();
          $("pay").value = invoice.pay;
          $("custZip").value = invoice.custZip;
          $("custAddr").value = invoice.custAddr;

          // 商品データを設定
          clearRows();
          invoice.items.forEach((item, index) => {
            if (index > 0) addRow();
            const tr = $("body").rows[index];
            tr.querySelector("td:first-child input").value = item.code;
            tr.querySelector("td:nth-child(2) textarea").value = item.description;
            tr.querySelector(".price").value = item.price;
            tr.querySelector(".qty").value = item.qty;
          });
          calc();

          // 納品書作成ページに切り替え
          document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.page === 'create') btn.classList.add('active');
          });
          document.querySelectorAll('.page').forEach(page => {
            page.classList.remove('active');
            if (page.id === 'create-page') page.classList.add('active');
          });

        } catch (error) {
          console.error('納品書読み込みエラー:', error);
          showStatus('納品書の読み込みに失敗しました', 'error');
        }
      }

      async function deleteInvoice(no) {
        if (!confirm('この納品書を削除しますか？')) return;

        try {
          await database.ref('invoices/' + no).remove();
          showStatus('納品書を削除しました');
          loadHistory(); // 履歴を更新
        } catch (error) {
          console.error('削除エラー:', error);
          showStatus('削除に失敗しました', 'error');
        }
      }

      async function searchInvoices() {
        const searchNo = $('search-no').value.trim();
        const searchDate = $('search-date').value;

        try {
          const snapshot = await database.ref('invoices').once('value');
          const invoicesData = snapshot.val();

          if (!invoicesData) {
            $('history-body').innerHTML = '';
            $('no-history').style.display = 'block';
            return;
          }

          let invoices = Object.keys(invoicesData).map(key => ({
            ...invoicesData[key],
            id: key
          }));

          if (searchNo) {
            invoices = invoices.filter(inv =>
              inv.no.toLowerCase().includes(searchNo.toLowerCase())
            );
          }

          if (searchDate) {
            invoices = invoices.filter(inv =>
              inv.deliver === searchDate
            );
          }

          // 検索結果を表示
          const historyBody = $('history-body');
          const noHistory = $('no-history');

          if (invoices.length === 0) {
            historyBody.innerHTML = '';
            noHistory.style.display = 'block';
            return;
          }

          noHistory.style.display = 'none';
          historyBody.innerHTML = '';

          invoices.forEach(invoice => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="checkbox-cell"><input type="checkbox" class="select-item" data-no="${invoice.no}"></td>
              <td>${invoice.no}</td>
              <td>${invoice.issue}</td>
              <td>${formatDateForDisplay(invoice.deliver)}</td>
              <td>${invoice.custName}</td>
              <td>${invoice.total}</td>
              <td class="action-cell">
                <button class="btn" onclick="loadInvoice('${invoice.no}')">表示</button>
                <button class="btn secondary" onclick="deleteInvoice('${invoice.no}')">削除</button>
              </td>
            `;
            historyBody.appendChild(tr);
          });

        } catch (error) {
          console.error('検索エラー:', error);
          showStatus('検索に失敗しました', 'error');
        }
      }

      function clearSearch() {
        $('search-no').value = '';
        $('search-date').value = '';
        loadHistory();
      }

      function updateInvoiceNo() {
        const now = new Date();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
        const newNo = `G25N${mm}${dd}-${String(Math.floor(Math.random() * 90) + 10)}`;
        $("no").textContent = newNo;
        $("issue").textContent = `${now.getFullYear()}/${mm}/${dd}`;

        // 納品日の初期値を3日後に設定
        const deliverDate = new Date(now);
        deliverDate.setDate(now.getDate() + 3);
        const deliverMM = String(deliverDate.getMonth() + 1).padStart(2, "0");
        const deliverDD = String(deliverDate.getDate()).padStart(2, "0");
        $("deliver").value = `${deliverDate.getFullYear()}-${deliverMM}-${deliverDD}`;
        updateDeliverDisplay();

        // フォームをクリア
        $("custName").value = "";
        updatePrintName();
        $("pay").selectedIndex = 0;
        $("custZip").value = "";
        $("custAddr").value = "";
        clearRows();
      }

      function downloadSelected() {
        const selectedItems = document.querySelectorAll('.select-item:checked');
        if (selectedItems.length === 0) {
          alert('ダウンロードする項目を選択してください');
          return;
        }

        // 選択された納品書番号を収集
        const selectedNos = Array.from(selectedItems).map(item => item.dataset.no);

        // Firebaseから選択された納品書データを取得
        Promise.all(
          selectedNos.map(no =>
            database.ref('invoices/' + no).once('value').then(snapshot => snapshot.val())
          )
        ).then(invoices => {
          // 選択した納品書データをJSONファイルとしてダウンロード
          const dataStr = JSON.stringify(invoices, null, 2);
          const dataBlob = new Blob([dataStr], {type: 'application/json'});
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `invoices_${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }).catch(error => {
          console.error('ダウンロードエラー:', error);
          showStatus('ダウンロードに失敗しました', 'error');
        });
      }

      async function deleteSelected() {
        const selectedItems = document.querySelectorAll('.select-item:checked');
        if (selectedItems.length === 0) {
          alert('削除する項目を選択してください');
          return;
        }

        if (!confirm(`選択した${selectedItems.length}件の納品書を削除しますか？`)) return;

        try {
          const deletePromises = Array.from(selectedItems).map(item =>
            database.ref('invoices/' + item.dataset.no).remove()
          );

          await Promise.all(deletePromises);
          showStatus(`${selectedItems.length}件の納品書を削除しました`);
          loadHistory(); // 履歴を更新
        } catch (error) {
          console.error('一括削除エラー:', error);
          showStatus('削除に失敗しました', 'error');
        }
      }

      // 全選択/全解除機能
      $('select-all').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.select-item');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });

      function addRow() {
      if ($("body").rows.length >= MAX_ROWS) {
      alert("商品は最大5件までです");
      return;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
      <td><input placeholder="H001"></td>
      <td><textarea placeholder="HERMÈS ケリー25"></textarea></td>
      <td class="num"><input type="number" min="0" step="1" placeholder="0" class="price"></td>
      <td class="num"><input type="number" min="1" step="1" value="1" class="qty"></td>
      <td class="line-total">¥0</td>`;
      $("body").appendChild(tr);

      // 価格入力フィールドにフォーカスイベントを追加
      const priceInput = tr.querySelector(".price");
      priceInput.addEventListener("focus", function() {
      this.select();
      });

      tr.querySelectorAll("input,textarea").forEach(i => i.addEventListener("input", calc));
      rowCounter++;
      calc();
      }

      function clearRows() {
      $("body").innerHTML = "";
      rowCounter = 1;
      addRow();
      }

      function calc() {
      let total = 0;
      [...$("body").rows].forEach(tr => {
      const price = Number(tr.querySelector(".price").value) || 0;
      const qty = Number(tr.querySelector(".qty").value) || 0;
      const line = price * qty;
      tr.querySelector(".line-total").textContent = fmt(line);
      total += line;
      });
      $("total").textContent = fmt(total);
      const ex = Math.round(total / 1.1);
      const tax = total - ex;
      $("exSub").textContent = fmt(ex);
      $("tax").textContent = fmt(tax);
      }

      // 郵便番号の自動フォーマット
      function formatZipCode() {
      const zipInput = $("custZip");
      let value = zipInput.value.replace(/-\D/g, '');

      if (value.length > 8) {
      value = value.substring(0, 8);
      }

      zipInput.value = value;
      }

      // 納品日の表示更新
      function updateDeliverDisplay() {
      const deliverDate = $("deliver").value;
      if (deliverDate) {
      const date = new Date(deliverDate);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      $("deliver-display").textContent = `${year}/${month}/${day}`;
      }
      }

      // 顧客名の印刷用データ属性を更新
      function updatePrintName() {
      const nameContainer = $("name-container");
      const custName = $("custName").value || "";
      nameContainer.setAttribute("data-print-name", custName);
      }

      // イベントリスナーの設定
      $("add").onclick = addRow;
      $("clear").onclick = clearRows;
      $("save").onclick = saveInvoice;
      $("search-btn").onclick = searchInvoices;
      $("clear-search").onclick = clearSearch;
      $("update-no").onclick = updateInvoiceNo;
      $("download-selected").onclick = downloadSelected;
      $("delete-selected").onclick = deleteSelected;

      // 郵便番号入力のイベントリスナー
      $("custZip").addEventListener('input', formatZipCode);

      // 納品日のイベントリスナー
      $("deliver").addEventListener('change', updateDeliverDisplay);

      // 顧客名入力のイベントリスナー
      $("custName").addEventListener('input', updatePrintName);

      // 初期設定
      updateInvoiceNo();

      // 顧客名の初期設定
      updatePrintName();

      addRow();
    </script>
  </body>
</html>
